/**
 * --------------------------------------------------------------------
 * jQuery-Plugin "visualize"
 * by Scott Jehl, scott@filamentgroup.com
 * http://www.filamentgroup.com
 * Copyright (c) 2009 Filament Group 
 * Dual licensed under the MIT (filamentgroup.com/examples/mit-license.txt) and GPL (filamentgroup.com/examples/gpl-license.txt) licenses.
 * 	
 * --------------------------------------------------------------------
 */
!function(e){e.fn.visualize=function(a,t){return e(this).each(function(){var i=e.extend({type:"bar",width:e(this).width(),height:e(this).height(),appendTitle:!0,title:null,appendKey:!0,colors:["#ae432e","#77ab13","#058dc7","#ef561a","#8d10ee","#5a3b16","#26a4ed","#f45a90","#e9e744"],textColors:[],parseDirection:"x",pieMargin:10,pieLabelsAsPercent:!0,pieLabelPos:"inside",lineWeight:4,lineDots:!1,dotInnerColor:"#ffffff",lineMargin:a.lineDots?15:0,barGroupMargin:10,chartId:"",xLabelParser:null,valueParser:null,chartId:"",chartClass:"",barMargin:1,yLabelInterval:30,interaction:!1},a);i.width=parseFloat(i.width),i.height=parseFloat(i.height),"line"!=i.type&&"area"!=i.type&&(i.lineMargin=0);var n=e(this),l={},o=i.colors,s=i.textColors,r=function(a){var t=[];return"x"==a?n.find("thead tr").each(function(a){e(this).find("th").each(function(i){t[i]||(t[i]=[]),t[i][a]=e(this).text()})}):n.find("tbody tr").each(function(a){e(this).find("th").each(function(i){t[a]||(t[a]=[]),t[a][i]=e(this).text()})}),t},h=i.valueParser||parseFloat,c=l.dataGroups=[];if("x"==i.parseDirection)n.find("tbody tr").each(function(a,t){c[a]={},c[a].points=[],c[a].color=o[a],s[a]&&(c[a].textColor=s[a]),e(t).find("td").each(function(t,i){c[a].points.push({value:h(e(i).text()),elem:i,tableCords:[a,t]})})});else for(var u=n.find("tbody tr:eq(0) td").size(),d=0;u>d;d++)c[d]={},c[d].points=[],c[d].color=o[d],s[d]&&(c[d].textColor=s[d]),n.find("tbody tr").each(function(a){c[d].points.push({value:1*e(this).find("td").eq(d).text(),elem:this,tableCords:[d,a]})});var p=l.allItems=[];e(c).each(function(a,t){var i=0;e.each(t.points,function(e,a){p.push(a),i+=a.value}),t.groupTotal=i}),l.dataSum=0,l.topValue=0,l.bottomValue=1/0,e.each(p,function(e,a){l.dataSum+=h(a.value),h(a.value,10)>l.topValue&&(l.topValue=h(a.value,10)),a.value<l.bottomValue&&(l.bottomValue=h(a.value))});var v=l.dataSum;l.topValue;var f=l.bottomValue;l.xAllLabels=r(i.parseDirection);var g=l.yAllLabels=r("x"===i.parseDirection?"y":"x"),b=l.xLabels=[];e.each(l.xAllLabels,function(e,a){l.xLabels.push(a[0])});var M=l.totalYRange=l.topValue-l.bottomValue,z=l.zeroLocX=0;if(e.isFunction(i.xLabelParser)){var m=null,w=null;e.each(b,function(e,a){a=b[e]=i.xLabelParser(a),0===e&&(m=a,w=a),a>m&&(m=a),w>a&&(w=a)});var C=l.totalXRange=m-w,y=l.xScale=(i.width-2*i.lineMargin)/C;i.lineMargin&&-2*y-i.lineMargin,z=l.zeroLocX=w+i.lineMargin,l.xBottomValue=w,l.xTopValue=m,l.totalXRange=C}var x=l.yScale=(i.height-2*i.lineMargin)/M,L=l.zeroLocY=(i.height-2*i.lineMargin)*(l.topValue/l.totalYRange)+i.lineMargin,P=l.yLabels=[],T=Math.floor((i.height-2*i.lineMargin)/30),I=l.totalYRange/T;I=5*Math.round(parseFloat(I)/5),I=Math.max(I,1);for(var V=5*Math.round(parseInt(l.bottomValue)/5);V<=l.topValue+I;V+=I)P.push(V);P[P.length-1]>l.topValue+I?P.pop():P[P.length-1]<=l.topValue-10&&P.push(l.topValue),e.each(c,function(a,t){t.yLabels=l.yAllLabels[a],e.each(t.points,function(e,i){i.zeroLocY=l.zeroLocY,i.zeroLocX=l.zeroLocX,i.xLabels=l.xAllLabels[e],i.yLabels=l.yAllLabels[a],i.color=t.color})});try{console.log(l)}catch(S){}var D={};D.pie={interactionPoints:c,setup:function(){D.pie.draw(!0)},draw:function(a){var t=Math.round(X.width()/2),n=Math.round(X.height()/2),o=n-i.pieMargin,s=0;if(a){k.addClass("visualize-pie"),"outside"==i.pieLabelPos&&k.addClass("visualize-pie-outside");var r=e('<ul class="visualize-labels"></ul>').insertAfter(X)}e.each(c,function(h,u){var d=u.groupTotal/v;if(!(0>=d||isNaN(d))){if(H.beginPath(),H.moveTo(t,n),H.arc(t,n,o,2*s*Math.PI-.5*Math.PI,2*(s+d)*Math.PI-.5*Math.PI,!1),H.lineTo(t,n),H.closePath(),H.fillStyle=c[h].color,H.fill(),a){var p=s+d/2,f="inside"==i.pieLabelPos?o/1.5:o+o/5,g=Math.round(t+Math.sin(2*p*Math.PI)*f),b=Math.round(n-Math.cos(2*p*Math.PI)*f),M=g>t?"right":"left",z=b>n?"bottom":"top",m=parseFloat((100*d).toFixed(2));if(u.canvasCords=[g,b],u.zeroLocY=l.zeroLocY=0,u.zeroLocX=l.zeroLocX=0,u.value=u.groupTotal,m){var w=i.pieLabelsAsPercent?m+"%":u.groupTotal,C=e('<span class="visualize-label">'+w+"</span>").css(M,0).css(z,0);C&&e('<li class="visualize-label-pos"></li>').appendTo(r).css({left:g,top:b}).append(C),C.css("font-size",o/8).css("margin-"+M,-C.width()/2).css("margin-"+z,-C.outerHeight()/2),c[h].textColor&&C.css("color",c[h].textColor)}}s+=d}})}},function(){var a,t=function(e,a,t,i,n){e.moveTo(a,t),e.beginPath(),e.arc(a,t,n/2,0,2*Math.PI,!1),e.closePath(),e.fillStyle=i,e.fill()};D.line={interactionPoints:p,setup:function(t){t?k.addClass("visualize-area"):k.addClass("visualize-line");var n=e('<ul class="visualize-labels-x"></ul>').width(X.width()).height(X.height()).insertBefore(X);i.customXLabels?i.customXLabels(l,n):(a=(X.width()-2*i.lineMargin)/(b.length-1),e.each(b,function(t){var l=e("<li><span>"+this+"</span></li>").prepend('<span class="line" />').css("left",i.lineMargin+a*t).appendTo(n),o=l.find("span:not(.line)"),s=o.width()/-2;0==t?s=0:t==b.length-1&&(s=-o.width()),o.css("margin-left",s).addClass("label")})),(X.height()-2*i.lineMargin)/(P.length-1);var o=e('<ul class="visualize-labels-y"></ul>').width(X.width()).height(X.height()).insertBefore(G);e.each(P,function(a){var t=Math.floor(this),n=(t-f)*x+i.lineMargin;if(!(n>=i.height-1||0>n)){var l=e("<li><span>"+t+"</span></li>").css("bottom",n);Math.abs(n)<i.height-1&&l.prepend('<span class="line"  />'),l.prependTo(o);var s=l.find("span:not(.line)"),r=s.height()/-2;i.lineMargin||(0==a?r=-s.height():a==P.length-1&&(r=0)),s.css("margin-top",r).addClass("label")}}),H.translate(z,L),D.line.draw(t)},draw:function(o){H.clearRect(-z,-L,i.width,i.height);var s;e.each(c,function(t,n){s=i.lineMargin,e.each(n.points,function(e,t){t.canvasCords=i.xLabelParser?[(b[e]-z)*y-w,-(t.value*x)]:[s,-(t.value*x)],i.lineDots&&(t.dotSize=i.dotSize||i.lineWeight*Math.PI,t.dotInnerSize=i.dotInnerSize||i.lineWeight*Math.PI/2,"double"==i.lineDots&&(t.innerColor=i.dotInnerColor)),s+=a})}),n.trigger("vizualizeBeforeDraw",{options:i,table:n,canvasContain:k,tableData:l}),e.each(c,function(){if(H.beginPath(),H.lineWidth=i.lineWeight,H.lineJoin="round",e.each(this.points,function(e){var a=this.canvasCords;0==e&&H.moveTo(a[0],a[1]),H.lineTo(a[0],a[1])}),H.strokeStyle=this.color,H.stroke(),o){var a=this.points[this.points.length-1].canvasCords[0];isFinite(a)&&H.lineTo(a,0),H.lineTo(i.lineMargin,0),H.closePath(),H.fillStyle=this.color,H.globalAlpha=.3,H.fill(),H.globalAlpha=1}else H.closePath()}),i.lineDots&&e.each(c,function(){e.each(this.points,function(){t(H,this.canvasCords[0],this.canvasCords[1],this.color,this.dotSize),"double"===i.lineDots&&t(H,this.canvasCords[0],this.canvasCords[1],this.innerColor,this.dotInnerSize)})})}}}(),D.area={setup:function(){D.line.setup(!0)},draw:D.line.draw},function(){var a,t;D.bar={setup:function(){a="horizontal"==i.barDirection,k.addClass("visualize-bar"),t=a?P:b;var n=X.width()/(t.length-(a?1:0)),l=e('<ul class="visualize-labels-x"></ul>').width(X.width()).height(X.height()).insertBefore(X);e.each(t,function(t){var i=e('<li><span class="label">'+this+"</span></li>").prepend('<span class="line" />').css("left",n*t).width(n).appendTo(l);if(a){var o=i.find("span.label");o.css("margin-left",-o.width()/2)}});var o=a?b:P,s=X.height()/(o.length-(a?0:1)),r=e('<ul class="visualize-labels-y"></ul>').width(X.width()).height(X.height()).insertBefore(X);e.each(o,function(t){var i=e("<li><span>"+this+"</span></li>").prependTo(r),n=i.find("span:not(.line)").addClass("label");if(a){n.css({"min-height":s,"max-height":s+1,"vertical-align":"middle"}),i.css({top:s*t,"min-height":s});var l=n[0].getClientRects()[0];l.bottom-l.top==s?n.css("line-height",parseInt(s)+"px"):n.css("overflow","hidden")}else i.css("bottom",s*t).prepend('<span class="line" />'),n.css("margin-top",-n.height()/2)}),D.bar.draw()},draw:function(){if(a?H.rotate(Math.PI/2):H.translate(0,L),!(0>=M))for(var e=(a?X.width():X.height())/M,n=a?X.height()/b.length:X.width()/t.length,l=(n-2*i.barGroupMargin)/c.length,o=0;o<c.length;o++){H.beginPath();var s=l-2*i.barMargin;H.lineWidth=s;for(var r=c[o].points,h=0,u=0;u<r.length;u++){if(0!=r[u].value){var d=h-i.barGroupMargin+o*l+l/2;d+=2*i.barGroupMargin,H.moveTo(d,0),H.lineTo(d,Math.round(-r[u].value*e))}h+=n}H.strokeStyle=c[o].color,H.stroke(),H.closePath()}}}}();var A=document.createElement("canvas"),X=e(A).attr({height:i.height,width:i.width}),Y=i.title||n.find("caption").text(),k=(t||e("<div "+(i.chartId?'id="'+i.chartId+'" ':"")+'class="visualize '+i.chartClass+'" role="img" aria-label="Chart representing data from the table: '+Y+'" />')).height(i.height).width(i.width),G=e('<div class="visualize-scroller"></div>').appendTo(k).append(X);if(i.appendTitle||i.appendKey)var R=e('<div class="visualize-info"></div>').appendTo(k);if(i.appendTitle&&e('<div class="visualize-title">'+Y+"</div>").appendTo(R),i.appendKey){var F=e('<ul class="visualize-key"></ul>');e.each(g,function(a,t){e('<li><span class="visualize-key-color" style="background: '+c[a].color+'"></span><span class="visualize-key-label">'+t+"</span></li>").appendTo(F)}),F.appendTo(R)}if(i.interaction){var W=e('<div class="visualize-interaction-tracker"/>').css({height:i.height+"px",width:i.width+"px",position:"relative","z-index":200}).insertAfter(X),B=function(a,t){var t=e.extend({canvasContain:k,tableData:l},t);n.trigger("vizualize"+a,t)},O=!1,q=!1,E=!1;W.mousemove(function(a){var t,n,l,o,s,r,h,c=a.originalEvent;t=c.layerX||c.offsetX||0,n=c.layerY||c.offsetY||0,h=!1,r=E?3e4:"pie"==i.type?(Math.round(X.height()/2)-i.pieMargin)/3:4*i.lineWeight,e.each(D[i.type].interactionPoints,function(e,a){l=a.canvasCords[0]+z,o=a.canvasCords[1]+("pie"==i.type?0:L),s=Math.sqrt((l-t)*(l-t)+(o-n)*(o-n)),r>s&&(h=a,r=s)}),i.multiHover&&h&&(t=h.canvasCords[0]+z,n=h.canvasCords[1]+("pie"==i.type?0:L),h=[h],e.each(D[i.type].interactionPoints,function(e,a){a!=h[0]&&(l=a.canvasCords[0]+z,o=a.canvasCords[1]+L,s=Math.sqrt((l-t)*(l-t)+(o-n)*(o-n)),s<=i.multiHover&&h.push(a))})),O=h,O!=q&&(O&&(q&&B("Out",{point:q}),B("Over",{point:O}),q=O),q&&!O&&(B("Out",{point:q}),q=!1),E=!0)}),W.mouseleave(function(){B("Out",{point:q,mouseOutGraph:!0}),O=q=!1})}t||k.insertAfter(this),"undefined"!=typeof G_vmlCanvasManager&&(G_vmlCanvasManager.init(),G_vmlCanvasManager.initElement(X[0]));var H=X[0].getContext("2d");G.scrollLeft(i.width-G.width()),e.each(e.visualizePlugins,function(e,a){a.call(n,i,l)}),D[i.type].setup(),t||(n.bind("visualizeRefresh",function(){n.visualize(i,e(this).empty())}),n.bind("visualizeRedraw",function(){D[i.type].draw()}))}).next()},e.visualizePlugins=[]}(jQuery);